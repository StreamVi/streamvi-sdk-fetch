# StreamVi SDK - Development Guide

Руководство для разработчиков библиотеки StreamVi SDK.

## Генерация API-клиента

### Автоматическая генерация с production-сервера

```bash
npm run gen:api-prod
```

Эта команда:
1. Скачивает OpenAPI спецификацию с `napi.streamvi.io`
2. Предварительно обрабатывает спецификацию для исправления общих проблем
3. Генерирует TypeScript клиент в `src/generated/api2/`
4. Автоматически исправляет общие проблемы:
   - Исправляет именование enum (camelCase → PascalCase)
   - Устанавливает правильные версии по умолчанию для методов (например, `paySettingGetSettingV3` использует версию 3 по умолчанию)
   - Удаляет ненужные суффиксы из имен методов
   - Исправляет несоответствия типов

### Ручная генерация (если у вас есть локальный файл спецификации)

```bash
# Поместите OpenAPI спецификацию в temp/backend_v2.json
npm run gen-process
```

## Автоматическая коррекция ошибок

Процесс генерации включает автоматическую коррекцию ошибок:

- **Исправляет именование enum**: Конвертирует `camelCaseVEnum` в `PascalCaseVEnum`
- **Устанавливает правильные версии по умолчанию**: Методы вроде `paySettingGetSettingV3` автоматически используют версию 3 по умолчанию
- **Обрабатывает все API файлы**: Автоматически сканирует и исправляет все 39+ сгенерированных API файлов
- **Предоставляет подробные отчеты**: Показывает точно, что было исправлено в каждом файле
- **Обрабатывает несоответствия типов**: Исправляет общие проблемы с типами TypeScript в сгенерированном коде

Пример автоматических исправлений:
```typescript
// До исправления:
const actualV: paySettingGetSettingV3VEnum = requestParameters.v || PaySettingGetSettingV3VEnum._1;

// После исправления:
const actualV: PaySettingGetSettingV3VEnum = requestParameters.v || PaySettingGetSettingV3VEnum._3;
```

## Предварительная обработка

Этап предварительной обработки (`clean-openapi-spec.js`) обрабатывает:
- Удаление недопустимых символов из OpenAPI спецификации
- Исправление неправильно сформированных JSON структур
- Нормализация определений endpoint'ов
- Обеспечение совместимости с генератором TypeScript

## Постобработка

Этап постобработки (`postprocess-api.js`) обрабатывает:
- Исправления имен enum во всех сгенерированных файлах
- Назначение версий по умолчанию для версионных методов
- Исправления согласованности типов
- Исправления операторов import

## Структура скриптов

```
src/scripts/
├── openapi-fetcher.mjs     # Скрипт для загрузки OpenAPI спецификации
├── clean-openapi-spec.js   # Скрипт предварительной обработки OpenAPI спецификации
└── postprocess-api.js      # Скрипт автоматической коррекции ошибок
```

## Тестирование

### Тестирование предварительной обработки

```bash
npm run test:preprocessing
```

### Тестирование постобработки

```bash
npm run test:postprocessing
```

### Полное тестирование

```bash
npm test
```

## Отладка генерации

Если возникают проблемы с генерацией API:

1. **Проверьте исходную спецификацию**: Убедитесь, что файл `temp/backend_v2.json` корректен
2. **Запустите предварительную обработку отдельно**: `node scripts/clean-openapi-spec.js`
3. **Проверьте логи генерации**: OpenAPI Generator выводит подробные логи
4. **Запустите постобработку отдельно**: `node scripts/postprocess-api.js`

## Добавление новых исправлений

Чтобы добавить новые автоматические исправления:

1. Отредактируйте `scripts/postprocess-api.js`
2. Добавьте соответствующие тесты в `tests/postprocess-api.test.ts`
3. Запустите тесты: `npm run test:postprocessing`
4. Протестируйте на полной генерации: `npm run gen:api-prod`

## Версионирование API

При добавлении поддержки новых версий API:

1. Обновите логику в `postprocess-api.js` для установки правильных версий по умолчанию
2. Добавьте тесты для новых версий
3. Обновите документацию с примерами использования новых версий

## Публикация

Перед публикацией новой версии:

1. Обновите версию в `package.json`
2. Запустите полную генерацию: `npm run gen:api-prod`
3. Запустите тесты: `npm test`
4. Соберите проект: `npm run build`
5. Проверьте линтинг: `npm run lint`
6. Опубликуйте: `npm publish` 