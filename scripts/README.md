# Постобработка API

Этот документ описывает решение проблемы с параметрами версии в сгенерированных API файлах.

## Проблема

При генерации API клиента из OpenAPI спецификации возникали следующие проблемы:

1. **Длинные имена методов**: `paySettingControllerCheckCountryV1` вместо `checkCountryV1`
2. **Обязательные параметры версии**: параметр `v` был обязательным, хотя версия уже указана в имени метода
3. **Отсутствие автоматического заполнения**: пользователю приходилось вручную указывать версию

## Решение

Создан универсальный скрипт постобработки `scripts/postprocess-api.js`, который:

### 1. Переименовывает методы
- Убирает префиксы контроллеров из имен методов
- `paySettingControllerCheckCountryV1` → `checkCountryV1`
- `siteUserProjectControllerGetProjectInfoV1` → `getProjectInfoV1`

### 2. Делает параметры версии опциональными
- В интерфейсах запросов: `readonly v: Type` → `readonly v?: Type`
- В сигнатурах функций: `(v: Type, ...)` → `(v?: Type, ...)`
- Убирает проверки обязательности параметра `v`

### 3. Добавляет автоматическое заполнение версий
- Извлекает версию из имени метода (`checkCountryV1` → версия `1`)
- Автоматически подставляет версию, если она не указана пользователем
- Добавляет блоки `else` с автоматическим заполнением

## Использование

### Автоматическая постобработка
```bash
# Полная генерация с постобработкой
npm run gen-process

# Только постобработка существующих файлов
node scripts/postprocess-api.js
```

### Результат
После постобработки API методы можно использовать так:

```typescript
// ✅ Версия подставляется автоматически из имени метода
await api.checkCountryV1({
  language: 'ru',
  projectId: 123,
  countryId: 456
  // v: '1' - подставляется автоматически
});

// ✅ Можно явно указать другую версию
await api.checkCountryV1({
  language: 'ru',
  projectId: 123,
  countryId: 456,
  v: '2' // переопределяет автоматическую версию
});

// ✅ Версия 3 подставляется автоматически
await api.getSettingV3({
  language: 'ru',
  projectId: 123
  // v: '3' - подставляется автоматически
});
```

## Технические детали

### Обрабатываемые паттерны
Скрипт автоматически находит и обрабатывает:

1. **Контроллеры**: все уникальные префиксы `*Controller*`
2. **Методы с версиями**: паттерн `*V\d+` (V1, V2, V3, и т.д.)
3. **Интерфейсы запросов**: `readonly v: Type`
4. **Сигнатуры функций**: в AxiosParamCreator и ApiFp
5. **Проверки параметров**: `assertParamExists(..., 'v', v)`

### Статистика обработки
При запуске скрипт выводит подробную статистику:
- Количество обработанных файлов
- Количество переименованных методов
- Количество исправленных интерфейсов
- Количество добавленных автоматических версий

### Безопасность
- Скрипт работает только с файлами в `src/generated/api2/api/*.ts`
- Создает резервные копии перед изменениями
- Обрабатывает только методы с версиями в имени
- Не затрагивает методы без версий

## Примеры

### До постобработки
```typescript
// ❌ Длинное имя и обязательный параметр v
await api.paySettingControllerCheckCountryV1({
  v: '1', // обязательно
  language: 'ru',
  projectId: 123,
  countryId: 456
});
```

### После постобработки
```typescript
// ✅ Короткое имя и автоматическая версия
await api.checkCountryV1({
  language: 'ru',
  projectId: 123,
  countryId: 456
  // v: '1' подставляется автоматически
});
```

## Конфигурация

Скрипт автоматически определяет:
- Все контроллеры в API файлах
- Версии из имен методов
- Типы параметров версии

Дополнительная конфигурация не требуется.

## Совместимость

- ✅ TypeScript/JavaScript
- ✅ Axios HTTP клиент
- ✅ OpenAPI Generator 7.x
- ✅ Windows/Linux/macOS
- ✅ Node.js 16+

## Устранение неполадок

### Скрипт не находит методы
Убедитесь, что методы имеют версии в имени (`*V1`, `*V2`, и т.д.)

### Ошибки TypeScript
Проверьте, что все интерфейсы обновлены корректно. При необходимости запустите скрипт повторно.

### Автоматические версии не работают
Убедитесь, что имена методов содержат версию в конце (`methodNameV1`, `methodNameV2`) 